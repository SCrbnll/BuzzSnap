name: CI/CD React Deployment

on:
  push:
    branches:
      - main  

jobs:
  build:
    name: ğŸ—ï¸ Realizando Build
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 21
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependencias
        run: npm install --progress=false

      - name: ğŸ“ Crear .env.production desde secrets
        run: |
          echo "VITE_URL_API=${{ secrets.VITE_URL_API }}" >> .env.production
          echo "VITE_SOCKET_URL=${{ secrets.VITE_SOCKET_URL }}" >> .env.production

      - name: ğŸ—ï¸ Construir la aplicaciÃ³n
        run: npm run build

      - name: ğŸ“¦ Guardar artefactos
        uses: actions/upload-artifact@v4 
        with:
          name: build-artifacts
          path: dist
          retention-days: 7  

  deploy:
    name: ğŸš€ Deploy a AWS
    needs: [build] 
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Descargar artefactos
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist

      - name: ğŸ“¤ Subir archivos al servidor (rsync)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "dist/*"
          target: "/var/www/buzzsnap/"

      - name: ğŸ”„ Reiniciar Nginx en el servidor
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            sudo systemctl restart nginx
